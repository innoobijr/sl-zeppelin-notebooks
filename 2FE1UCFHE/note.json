{
  "paragraphs": [
    {
      "text": "%spark.pyspark\r\n\r\nimport os\r\nfrom datetime import datetime\r\nimport matplotlib.pyplot as plt\r\nfrom pyspark.sql import SQLContext\r\n\r\nfrom pyspark.sql.types import StructType, StructField, StringType, IntegerType\r\nfrom pyspark.sql.functions import split, lower\r\nimport pyspark.sql.functions as F\r\nfrom pyspark.sql.window import Window\r\nfrom pyspark import StorageLevel",
      "user": "anonymous",
      "dateUpdated": "2020-07-09 15:59:30.265",
      "config": {
        "colWidth": 12.0,
        "fontSize": 9.0,
        "enabled": true,
        "results": {},
        "editorSetting": {
          "language": "python",
          "editOnDblClick": false,
          "completionKey": "TAB",
          "completionSupport": true
        },
        "editorMode": "ace/mode/python"
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "results": {
        "code": "SUCCESS",
        "msg": []
      },
      "apps": [],
      "jobName": "paragraph_1594224959072_789358027",
      "id": "20200708-161559_1145660513",
      "dateCreated": "2020-07-08 16:15:59.072",
      "dateStarted": "2020-07-09 15:59:30.280",
      "dateFinished": "2020-07-09 15:59:30.347",
      "status": "FINISHED",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%spark.pyspark\n\nACCESS_KEY \u003d os.environ[\u0027AWS_ID\u0027]\nSECRET_KEY \u003d os.environ[\u0027AWS_SECRET\u0027]\n\nsc._jsc.hadoopConfiguration().set(\"fs.s3n.awsAccessKeyId\", ACCESS_KEY)\nsc._jsc.hadoopConfiguration().set(\"fs.s3n.awsSecretAccessKey\", SECRET_KEY)\n\nsq \u003d SQLContext(sc)\n\ndailyPath \u003d \"s3n://sierra-leone-lake/blob/AGGREGATED_CDRS/africell/summaries/user_queries-daily\"\nweeklyPath \u003d \"s3n://sierra-leone-lake/blob/AGGREGATED_CDRS/africell/summaries/user_queries-weekly\"\nhourlyPath \u003d \"s3n://sierra-leone-lake/blob/AGGREGATED_CDRS/africell/summaries/user_queries-hourly\"",
      "user": "anonymous",
      "dateUpdated": "2020-07-09 16:07:45.146",
      "config": {
        "colWidth": 12.0,
        "fontSize": 9.0,
        "enabled": true,
        "results": {},
        "editorSetting": {
          "language": "python",
          "editOnDblClick": false,
          "completionKey": "TAB",
          "completionSupport": true
        },
        "editorMode": "ace/mode/python"
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "results": {
        "code": "SUCCESS",
        "msg": []
      },
      "apps": [],
      "jobName": "paragraph_1594225397346_-1982597034",
      "id": "20200708-162317_1250270320",
      "dateCreated": "2020-07-08 16:23:17.346",
      "dateStarted": "2020-07-09 16:07:45.161",
      "dateFinished": "2020-07-09 16:07:45.172",
      "status": "FINISHED",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%spark.pyspark\nnames\u003d{\u0027antenna_id\u0027: StringType(),\u0027time\u0027: StringType(),\u0027cdr_type\u0027: StringType(),\u0027source\u0027: StringType(),\u0027target\u0027: StringType(),\u0027duration\u0027: IntegerType()}\nfields\u003d[]\nfor header in names:\n    fields.append(StructField(header, names[header], False))\nschema \u003d StructType(fields)\n# df \u003d sq.read.csv(\u0027./data/20200321_20.csv\u0027, schema\u003dschema)\ndf \u003d sq.read.csv(\u0027s3n://sierra-leone-lake/blob/cdrs/africell-raw/2020042[1-3]_1[0-2].csv\u0027, schema\u003dschema)\n\ndf \u003d df.withColumn(\u0027direction\u0027, lower(split(df[\u0027cdr_type\u0027], \u0027 \u0027).getItem(0)))\\\n        .withColumn(\u0027subscriber\u0027, F.col(\u0027source\u0027))\\\n        .withColumn(\"call_datetime\", F.to_timestamp(\"time\"))\\\n        .withColumn(\"call_date\", F.to_date(\"call_datetime\"))\\\n        .withColumn(\"week\", F.weekofyear(\"call_date\"))\\\n        .withColumn(\"month\", F.month(\"call_date\"))\\\n        .withColumn(\"hour\", F.hour(\"call_date\"))\\\n        .withColumn(\"site\", F.expr(\"substring(antenna_id, 1, length(antenna_id)-1)\"))\ndf \u003d df.drop(\u0027time\u0027, \u0027cdr_type\u0027, \u0027source\u0027, \u0027target\u0027, \u0027direction\u0027, \u0027antenna_id\u0027)",
      "user": "anonymous",
      "dateUpdated": "2020-07-09 16:00:06.271",
      "config": {
        "colWidth": 12.0,
        "fontSize": 9.0,
        "enabled": true,
        "results": {},
        "editorSetting": {
          "language": "python",
          "editOnDblClick": false,
          "completionKey": "TAB",
          "completionSupport": true
        },
        "editorMode": "ace/mode/python"
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "results": {
        "code": "SUCCESS",
        "msg": []
      },
      "apps": [],
      "jobName": "paragraph_1594225413361_-1463632856",
      "id": "20200708-162333_433705629",
      "dateCreated": "2020-07-08 16:23:33.361",
      "dateStarted": "2020-07-09 16:00:06.295",
      "dateFinished": "2020-07-09 16:00:09.098",
      "status": "FINISHED",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%spark.pyspark\n\ndaily \u003d df.groupBy(\u0027subscriber\u0027, \u0027call_date\u0027).agg(F.count(\u0027call_date\u0027).alias(\u0027count\u0027))\n# daily.persist(StorageLevel.MEMORY_AND_DISK)\n\n# weekly \u003d daily\\\n#         .withColumn(\"week\", F.weekofyear(\"call_date\"))\\\n#         .groupBy(\u0027subscriber\u0027, \u0027week\u0027)\\\n#         .agg(F.sum(\u0027count\u0027).alias(\u0027count\u0027))\n\nhourly \u003d df.groupBy(\u0027subscriber\u0027, \u0027hour\u0027).agg(F.count(\u0027hour\u0027).alias(\u0027count\u0027))",
      "user": "anonymous",
      "dateUpdated": "2020-07-10 14:16:49.862",
      "config": {
        "colWidth": 12.0,
        "fontSize": 9.0,
        "enabled": true,
        "results": {},
        "editorSetting": {
          "language": "python",
          "editOnDblClick": false,
          "completionKey": "TAB",
          "completionSupport": true
        },
        "editorMode": "ace/mode/python"
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "results": {
        "code": "SUCCESS",
        "msg": []
      },
      "apps": [],
      "jobName": "paragraph_1594225432996_709827718",
      "id": "20200708-162352_1876247922",
      "dateCreated": "2020-07-08 16:23:52.997",
      "dateStarted": "2020-07-09 16:20:11.001",
      "dateFinished": "2020-07-09 16:20:11.161",
      "status": "FINISHED",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%spark.pyspark\ndaily.show()",
      "user": "anonymous",
      "dateUpdated": "2020-07-09 16:20:52.539",
      "config": {
        "colWidth": 12.0,
        "fontSize": 9.0,
        "enabled": true,
        "results": {},
        "editorSetting": {
          "language": "python",
          "editOnDblClick": false,
          "completionKey": "TAB",
          "completionSupport": true
        },
        "editorMode": "ace/mode/python"
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "results": {
        "code": "SUCCESS",
        "msg": [
          {
            "type": "TEXT",
            "data": "+--------------------+----------+-----+\n|          subscriber| call_date|count|\n+--------------------+----------+-----+\n|60BACF26E9FC68C30...|2020-04-23|   12|\n|2D792DD892AF1E044...|2020-04-23|   38|\n|66266D893F533A5B6...|2020-04-23|    9|\n|A983E70C9DF611B1C...|2020-04-23|   11|\n|A2E87AB98CF992676...|2020-04-23|    6|\n|3212680CCD2A6B9A5...|2020-04-23|    8|\n|2ADD12DDD00CCF634...|2020-04-23|    4|\n|923CA5F502A8F3378...|2020-04-23|   59|\n|FB6A6C3DBE1E457C6...|2020-04-23|    5|\n|28B57407CC6489273...|2020-04-23|   24|\n|08FA5DE64991AEB22...|2020-04-23|    2|\n|18B01A38FE4FBBE7F...|2020-04-23|    2|\n|9BDAF8DE14C38D185...|2020-04-23|   10|\n|2309CC61960FD2300...|2020-04-23|    1|\n|82D1A063DE76A8C26...|2020-04-23|   12|\n|0D4B36A91ADE84FD0...|2020-04-23|    5|\n|E36B1A0D2545B5D16...|2020-04-23|   12|\n|9E34EE00BE6AD9D7B...|2020-04-23|    4|\n|E87B587C27F698262...|2020-04-23|   14|\n|D8375E19D1E0C6227...|2020-04-23|    8|\n+--------------------+----------+-----+\nonly showing top 20 rows\n\n"
          }
        ]
      },
      "apps": [],
      "jobName": "paragraph_1594227316616_883492222",
      "id": "20200708-165516_706035272",
      "dateCreated": "2020-07-08 16:55:16.616",
      "dateStarted": "2020-07-09 16:20:52.555",
      "dateFinished": "2020-07-09 16:21:13.594",
      "status": "FINISHED",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%spark.pyspark\ndaily.coalesce(5).write.format(\"csv\").option(\"header\", \"true\").save(dailyPath)\n\n# weekly.coalesce(1).write.format(\"csv\").option(\"header\", \"true\").save(weeklyPath)\n\nhourly.coalesce(50).write.format(\"csv\").option(\"header\", \"true\").save(hourlyPath)",
      "user": "anonymous",
      "dateUpdated": "2020-07-09 16:19:50.600",
      "config": {
        "colWidth": 12.0,
        "fontSize": 9.0,
        "enabled": true,
        "results": {},
        "editorSetting": {
          "language": "python",
          "editOnDblClick": false,
          "completionKey": "TAB",
          "completionSupport": true
        },
        "editorMode": "ace/mode/python"
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "results": {
        "code": "SUCCESS",
        "msg": []
      },
      "apps": [],
      "jobName": "paragraph_1594228037845_-1722918678",
      "id": "20200708-170717_2103919054",
      "dateCreated": "2020-07-08 17:07:17.845",
      "dateStarted": "2020-07-09 16:07:49.601",
      "dateFinished": "2020-07-09 16:10:24.340",
      "status": "FINISHED",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%spark.pyspark",
      "user": "anonymous",
      "dateUpdated": "2020-07-09 16:03:28.563",
      "config": {
        "colWidth": 12.0,
        "fontSize": 9.0,
        "enabled": true,
        "results": {},
        "editorSetting": {
          "language": "scala",
          "editOnDblClick": false,
          "completionKey": "TAB",
          "completionSupport": true
        },
        "editorMode": "ace/mode/scala"
      },
      "settings": {
        "params": {},
        "forms": {}
      },
      "apps": [],
      "jobName": "paragraph_1594231847284_1582439521",
      "id": "20200708-181047_15831177",
      "dateCreated": "2020-07-08 18:10:47.285",
      "status": "READY",
      "progressUpdateIntervalMs": 500
    },
    {
      "text": "%spark.pyspark\n",
      "user": "anonymous",
      "dateUpdated": "2020-07-08 17:36:16.420",
      "config": {},
      "settings": {
        "params": {},
        "forms": {}
      },
      "apps": [],
      "jobName": "paragraph_1594229776419_-1379295449",
      "id": "20200708-173616_2084933677",
      "dateCreated": "2020-07-08 17:36:16.419",
      "status": "READY",
      "progressUpdateIntervalMs": 500
    }
  ],
  "name": "MIT/userQueries",
  "id": "2FE1UCFHE",
  "noteParams": {},
  "noteForms": {},
  "angularObjects": {
    "spark:shared_process": []
  },
  "config": {
    "isZeppelinNotebookCronEnable": false
  },
  "info": {}
}